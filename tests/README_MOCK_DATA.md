# Mock Data for CI Testing

This directory contains tools for generating mock data for CI/CD testing without requiring real datasets in the repository.

## ğŸ¯ Purpose

The mock data system allows:
- âœ… CI/CD pipeline to pass without committing large datasets
- âœ… Fast test execution with minimal data
- âœ… Consistent test environment across all developers
- âœ… Backwards compatibility with real data when available

## ğŸ“¦ Components

### 1. `generate_mock_data.py`
Script that generates fake CSV data matching expected schema:
- **FreshRetail format**: `freshretail_train.csv` (1000 rows, hourly sales data)
- **Dunnhumby format**: `transaction_data.csv`, `product.csv` (1000 rows, weekly data)
- **POC data**: `transaction_data.csv` (500 rows, minimal integration test data)

### 2. `conftest.py`
Pytest configuration providing:
- Shared fixtures for mock data generation
- Automatic fallback to mock when real data missing
- Directory structure creation
- Custom pytest markers (smoke, feature, integration)

## ğŸš€ Usage

### Generating Mock Data Locally

```bash
# From project root
python tests/generate_mock_data.py
```

This creates:
```
data/
â”œâ”€â”€ 2_raw/
â”‚   â”œâ”€â”€ freshretail_train.csv      # FreshRetail mock data
â”‚   â”œâ”€â”€ transaction_data.csv       # Dunnhumby mock data
â”‚   â””â”€â”€ product.csv                # Product reference data
â”œâ”€â”€ poc_data/
â”‚   â””â”€â”€ transaction_data.csv       # POC integration test data
â”œâ”€â”€ 3_processed/                   # (empty, for pipeline output)
â””â”€â”€ models/                        # (empty, for trained models)
```

### Running Tests with Mock Data

```bash
# Run all tests
pytest tests/ -v

# Run smoke tests only
pytest tests/ -v -m smoke

# Run feature tests only
pytest tests/ -v -m feature

# Run with coverage
pytest tests/ --cov=src --cov-report=term
```

### In CI/CD

Mock data is generated automatically:
```yaml
- name: Generate mock data for testing
  run: |
    python tests/generate_mock_data.py
```

## ğŸ“Š Mock Data Specifications

### FreshRetail Mock Data
- **Rows**: 1000
- **Time range**: 30 days (hourly)
- **Products**: 50 unique IDs (1000-1049)
- **Stores**: 10 unique IDs (1-10)
- **Cities**: 3 unique IDs (1-3)
- **Columns**: `product_id`, `store_id`, `city_id`, `dt`, `sale_amount`, `hour_timestamp`, `sales_quantity`

### Dunnhumby Mock Data
- **Rows**: 1000
- **Time range**: 52 weeks
- **Products**: 20 unique IDs (P1-P20)
- **Stores**: 5 unique IDs (S1-S5)
- **Columns**: `PRODUCT_ID`, `STORE_ID`, `WEEK_NO`, `SALES_VALUE`, `QUANTITY`, `RETAIL_DISC`, `COUPON_DISC`

### POC Integration Data
- **Rows**: 500
- **Time range**: 500 hours
- **Products**: 20 unique IDs (1000-1019)
- **Stores**: 4 unique IDs (1-4)
- **Columns**: `product_id`, `store_id`, `hour_timestamp`, `sales_quantity`

## ğŸ§° Test Fixtures

Conftest provides these fixtures automatically:

### Data Fixtures
- `mock_freshretail_data()` - In-memory FreshRetail DataFrame
- `mock_transaction_data()` - In-memory Dunnhumby DataFrame
- `mock_product_data()` - In-memory product reference DataFrame
- `sample_freshretail_data()` - Loads from file or returns mock
- `sample_transaction_data()` - Loads from file or returns mock
- `sample_master_data()` - Aggregated master DataFrame

### Utility Fixtures
- `project_root()` - Path to project root
- `ensure_directories()` - Creates required directories
- `sample_data_dir()` - Returns data directory path

### Using Fixtures in Tests

```python
def test_my_feature(sample_freshretail_data):
    """Test uses mock data automatically if real data not present."""
    df = sample_freshretail_data
    assert len(df) > 0
    assert 'product_id' in df.columns
```

## ğŸ”„ Fallback Logic

Tests follow this priority:
1. **Real data** (if present in `data/2_raw/` or `data/poc_data/`)
2. **Mock CSV** (if generated by script)
3. **In-memory mock** (generated by fixtures)

This ensures:
- âœ… CI always passes (uses mock)
- âœ… Developers can use real data locally
- âœ… No test failures from missing data

## âš ï¸ Important Notes

### Do NOT commit real data
```gitignore
# Already in .gitignore
data/2_raw/*.csv
data/2_raw/*.parquet
data/poc_data/*.csv
```

### Mock data is intentionally small
- Designed for **logic testing**, not performance
- Real data should be used for:
  - Model training
  - Performance benchmarking
  - Production validation

### Updating mock data schema
If you change data schema:
1. Update `generate_mock_data.py` to match new columns
2. Update fixtures in `conftest.py` if needed
3. Run `python tests/generate_mock_data.py` locally
4. Verify tests pass: `pytest tests/ -v`

## ğŸ› Troubleshooting

### Tests fail with "data not found"
```bash
# Regenerate mock data
python tests/generate_mock_data.py

# Verify files created
ls -la data/2_raw/
ls -la data/poc_data/
```

### Tests fail with schema mismatch
```bash
# Check mock data columns
python -c "import pandas as pd; print(pd.read_csv('data/2_raw/freshretail_train.csv').columns)"

# Compare with expected columns in test
grep -n "required_cols" tests/test_smoke.py
```

### CI fails but local tests pass
- Mock data script might not be running in CI
- Check `.github/workflows/ci.yml` has generation step
- Verify PYTHONPATH is set correctly in CI

## ğŸ“š Resources

- [Pytest Fixtures Documentation](https://docs.pytest.org/en/stable/fixture.html)
- [GitHub Actions Python Setup](https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python)
- [SmartGrocy Main Documentation](../docs/README.md)

---

**Questions?** Check [CI/CD Documentation](../.github/workflows/README.md) or open an issue.
